<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>标准详情 - 国家市场监督管理总局技术创新中心</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 FontAwesome 图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入 PDF.js 核心库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tech-blue': '#004098',   
                        'tech-dark': '#003380',
                        'text-main': '#333333',
                    },
                    fontFamily: {
                        'slogan': ['STKaiti', 'KaiTi', '楷体', 'FangSong', 'SimSun', 'serif'], 
                        'sans': ['Microsoft YaHei', 'PingFang SC', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: "Microsoft YaHei", sans-serif; }
        
        /* --- 头部科技感背景 (保持与 Index 一致) --- */
        .header-tech-bg {
            background-color: #001540;
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                linear-gradient(to right, #001540, #003380, #001540);
            position: relative;
        }
        .header-tech-bg::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px; pointer-events: none;
        }

        /* 导航栏特效 */
        .nav-item { position: relative; }
        .nav-item::after {
            content: ''; position: absolute; bottom: 8px; left: 50%; width: 0%; height: 2px;
            background-color: #fff; transform: translateX(-50%); transition: width 0.3s ease;
        }
        .nav-item:hover::after { width: 60%; }
        
        /* 下拉菜单动画 */
        .group:hover .group-hover\:block { display: block; animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* PDF 工具栏按钮样式 */
        .pdf-btn {
            @apply px-3 py-1.5 rounded text-gray-600 hover:bg-gray-200 hover:text-blue-700 transition text-sm flex items-center justify-center;
        }
        .pdf-btn:disabled {
            @apply opacity-50 cursor-not-allowed hover:bg-transparent hover:text-gray-600;
        }

        /* 状态标签颜色 */
        .badge-active { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .badge-draft { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
        .badge-upcoming { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .badge-expired { background-color: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; }
    </style>
</head>
<body class="bg-gray-50 text-[#333] flex flex-col min-h-screen">

    <!-- ================= 1. 顶部 Header (严格与 Index 一致) ================= -->
    <div class="w-full text-white pb-0 header-tech-bg">
        <header class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-7 relative z-10">
            <div class="flex flex-col lg:flex-row justify-between items-center gap-6">
                <!-- 左侧：Logo + 标题 -->
                <div class="flex items-center gap-5 self-start lg:self-center">
                    <div class="w-16 h-16 shrink-0 flex items-center justify-center">
                        <img src="figure/nevsc_logo.png" alt="Logo" class="w-full h-full object-contain drop-shadow-md" 
                             onerror="this.parentElement.innerHTML='<div class=\'text-white font-bold border border-white/30 p-2 rounded\'>LOGO</div>'">
                    </div>
                    <div class="flex flex-col justify-center gap-1">
                        <h1 class="text-sm md:text-lg text-blue-100 font-bold tracking-wide opacity-90 text-justify">
                            国家市场监督管理总局技术创新中心
                        </h1>
                        <h2 class="text-sm md:text-lg text-blue-100 font-medium tracking-wide opacity-90 text-justify">
                            (新能源汽车数字监管技术及应用)
                        </h2>
                    </div>
                </div>

                <!-- 右侧：搜索 -->
                <div class="flex flex-col items-end gap-2 w-full lg:w-auto mt-4 lg:mt-0">
                    <div class="relative w-full md:w-64 group">
                        <input type="text" id="global-search-input" placeholder="输入关键词..." autocomplete="off"
                            class="w-full bg-white/10 border border-white/20 text-white text-sm rounded-full pl-4 pr-10 py-1.5 
                                    focus:outline-none focus:bg-white/15 focus:border-blue-300 transition shadow-inner backdrop-blur-sm">
                        <button id="global-search-btn" class="absolute right-3 top-1/2 -translate-y-1/2 text-white/70 hover:text-white transition">
                            <i class="fa-solid fa-magnifying-glass text-lg"></i>
                        </button>
                        <div id="search-dropdown" class="hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-lg shadow-xl border border-gray-100 overflow-hidden z-50"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- 导航栏 -->
        <nav class="border-t border-white/10 mt-2 relative z-10" style="background-color: rgba(255, 255, 255, 0.05);"> 
            <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-wrap justify-center space-x-2">
                    <!-- 首页 (变为普通样式) -->
                    <a href="index.html" class="nav-item text-blue-100 hover:text-white px-8 py-4 text-base tracking-widest transition relative">首页</a>
                    
                    <a href="about.html" class="nav-item text-blue-100 hover:text-white px-6 py-4 font-medium transition text-base tracking-wide">中心概况</a>
                    <a href="news.html?category=news" class="nav-item text-blue-100 hover:text-white px-6 py-4 font-medium transition text-base tracking-wide">新闻动态</a>
                    <a href="activity.html" class="nav-item text-blue-100 hover:text-white px-6 py-4 font-medium transition text-base tracking-wide">行业活动</a>
                    
                    <!-- 标准研制 (高亮样式) -->
                    <a href="standards.html" class="text-white font-bold px-6 py-4 font-medium transition text-base tracking-wide relative after:content-[''] after:absolute after:bottom-0 after:left-0 after:w-full after:h-1 after:bg-white">标准研制</a>
                    
                    <a href="research.html" class="nav-item text-blue-100 hover:text-white px-6 py-4 font-medium transition text-base tracking-wide">技术研究</a>
                    
                    <div class="relative group h-full">
                        <button class="nav-item text-blue-100 hover:text-white px-6 py-4 font-medium transition flex items-center h-full text-base tracking-wide">
                            更多 <i class="fa-solid fa-angle-down ml-2 text-xs opacity-70"></i>
                        </button>
                        <div class="absolute left-0 top-full w-36 bg-white shadow-xl rounded-b-md hidden group-hover:block z-50">
                            <a href="#" class="block px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-[#004098] border-b border-gray-50">党建风采</a>
                            <a href="#" class="block px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-[#004098] border-b border-gray-50">人才招聘</a>
                            <a href="#" class="block px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-[#004098]">联系我们</a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </div>

    <!-- ================= 2. 面包屑导航 ================= -->
    <div class="bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="text-sm text-gray-500 flex items-center">
                <a href="index.html" class="hover:text-[#004098] transition"><i class="fa-solid fa-house mr-1"></i> 首页</a>
                <span class="mx-2 text-gray-300">/</span>
                <a href="standards.html" class="hover:text-[#004098] transition">标准研制</a>
                <span class="mx-2 text-gray-300">/</span>
                <span class="text-gray-800 font-medium">详情</span>
            </div>
        </div>
    </div>

    <!-- ================= 3. 详情主体 ================= -->
    <main class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-10 flex-grow w-full">
        
        <!-- Loading 提示 -->
        <div id="loading" class="text-center py-20 text-gray-500">
            <i class="fa-solid fa-spinner fa-spin text-3xl mb-4 text-[#004098]"></i>
            <p>正在加载标准详情...</p>
        </div>

        <div id="content-area" class="hidden bg-white rounded shadow-sm border border-gray-100 p-8 md:p-12">
            
            <!-- 头部基本信息 -->
            <div class="border-b border-gray-100 pb-8 mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                    <div class="flex items-center gap-3">
                        <span id="std-type-tag" class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold uppercase"></span>
                        <h1 class="text-2xl md:text-4xl font-bold text-[#004098] font-mono tracking-tight" id="std-code">加载中...</h1>
                    </div>
                    <span id="std-status" class="mt-2 md:mt-0 px-3 py-1 rounded text-sm font-bold">...</span>
                </div>
                
                <h2 class="text-xl md:text-2xl font-medium text-[#333] mb-6 leading-snug" id="std-title">...</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm text-gray-600 bg-gray-50 p-5 rounded border border-gray-100">
                    <div class="flex items-center"><i class="fa-regular fa-calendar-check mr-2 text-[#004098]"></i><span class="font-bold mr-2 whitespace-nowrap shrink-0">发布日期：</span> <span id="std-publish-date">-</span></div>
                    <div class="flex items-center"><i class="fa-regular fa-calendar-plus mr-2 text-[#004098]"></i><span class="font-bold mr-2 whitespace-nowrap shrink-0">实施日期：</span> <span id="std-implement-date">-</span></div>
                    <div class="flex items-center"><i class="fa-solid fa-building-columns mr-2 text-[#004098]"></i><span class="font-bold mr-2 whitespace-nowrap shrink-0">归口单位：</span> <span id="std-dept">-</span></div>
                </div>
            </div>

            <!-- 详细内容与操作 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                
                <!-- 左侧：内容摘要与预览 -->
                <div class="lg:col-span-2 space-y-8">
                    <div>
                        <h3 class="font-bold text-[#333] border-l-4 border-[#004098] pl-3 mb-4 text-lg">适用范围 / 标准描述</h3>
                        <div id="std-desc" class="text-gray-600 leading-relaxed text-justify text-base p-4 bg-gray-50/50 rounded">
                            <!-- JS 填充 -->
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between items-end mb-4 border-b border-gray-200 pb-2">
                            <h3 class="font-bold text-[#333] border-l-4 border-[#004098] pl-3 text-lg">文件预览</h3>
                            <span class="text-xs text-gray-400" id="preview-status-text">在线预览模式 (Canvas渲染)</span>
                        </div>

                        <!-- 优化后的预览容器 (高度设为 1100px) -->
                        <div id="pdf-viewer-container" class="w-full bg-gray-100 border border-gray-300 rounded overflow-hidden flex flex-col hidden relative">
                            <!-- 工具栏 -->
                            <div class="bg-gray-100 border-b border-gray-300 p-2 flex flex-wrap items-center justify-between gap-2 shadow-sm z-10 sticky top-0">
                                <!-- 翻页 -->
                                <div class="flex items-center gap-1">
                                    <button id="pdf-prev" class="pdf-btn" title="上一页"><i class="fa-solid fa-chevron-left"></i></button>
                                    <span class="text-xs font-mono mx-2">
                                        <span id="pdf-page-num" class="font-bold">1</span> / <span id="pdf-page-count">--</span>
                                    </span>
                                    <button id="pdf-next" class="pdf-btn" title="下一页"><i class="fa-solid fa-chevron-right"></i></button>
                                </div>
                                <!-- 缩放/旋转 -->
                                <div class="flex items-center gap-1">
                                    <button id="pdf-zoom-out" class="pdf-btn" title="缩小"><i class="fa-solid fa-minus"></i></button>
                                    <button id="pdf-zoom-in" class="pdf-btn" title="放大"><i class="fa-solid fa-plus"></i></button>
                                    <div class="w-px h-4 bg-gray-300 mx-1"></div>
                                    <button id="pdf-rotate" class="pdf-btn" title="旋转"><i class="fa-solid fa-rotate-right"></i></button>
                                </div>
                            </div>

                            <!-- Canvas 区域 (高度设为 1100px 确保显示一整页 A4) -->
                            <div class="flex-1 overflow-auto bg-[#525659] p-4 flex justify-center h-[1100px] relative" id="canvas-wrapper">
                                <canvas id="the-canvas" class="shadow-lg origin-top transition-transform duration-200"></canvas>
                                <!-- 加载中 Spinner -->
                                <div id="pdf-loading-spinner" class="absolute inset-0 flex items-center justify-center bg-gray-100/50 z-20">
                                    <i class="fa-solid fa-spinner fa-spin text-4xl text-[#004098]"></i>
                                </div>
                            </div>
                        </div>

                        <!-- 缺省/错误状态 -->
                        <div id="pdf-placeholder" class="w-full h-[600px] bg-gray-50 border border-gray-200 rounded flex flex-col items-center justify-center text-gray-400 hidden">
                            <i class="fa-regular fa-file-pdf text-5xl mb-4 text-gray-300"></i>
                            <p id="pdf-msg">暂无文件预览</p>
                        </div>
                    </div>
                </div>

                <!-- 右侧：下载与反馈 -->
                <div class="lg:col-span-1 space-y-6">
                    
                    <!-- 下载卡片 -->
                    <div class="bg-blue-50 p-6 rounded border border-blue-100 shadow-sm relative overflow-hidden group">
                        <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-100 rounded-full opacity-50 group-hover:scale-110 transition"></div>
                        <h3 class="font-bold text-[#004098] mb-4 text-lg relative z-10">获取标准全文</h3>
                        
                        <!-- 允许下载 -->
                        <div id="download-section" class="hidden">
                            <a id="download-btn" href="#" target="_blank" class="block w-full bg-[#004098] hover:bg-[#003380] text-white py-3 rounded font-bold transition mb-3 flex items-center justify-center shadow-md">
                                <i class="fa-solid fa-download mr-2"></i> 下载 PDF 文件
                            </a>
                            <p class="text-xs text-gray-500 text-center">点击下载完整版标准文件</p>
                        </div>
                        
                        <!-- 禁止下载 -->
                        <div id="no-download-section" class="hidden">
                            <button disabled class="w-full bg-gray-300 text-gray-500 py-3 rounded font-bold cursor-not-allowed flex items-center justify-center border border-gray-300">
                                <i class="fa-solid fa-lock mr-2"></i> 暂无下载权限
                            </button>
                            <p class="text-xs text-gray-500 text-center mt-2">该文档暂未开放下载</p>
                        </div>
                    </div>

                    <!-- 意见反馈 -->
                    <div class="bg-white p-6 rounded border border-gray-200 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4 text-lg">意见反馈</h3>
                        <p class="text-sm text-gray-500 mb-4 leading-relaxed">如果您对本标准有任何建议、疑问或发现内容错误，请通过邮件反馈给我们。</p>
                        <a href="mailto:nevsc@caeri.com.cn" class="block w-full border border-gray-300 text-gray-600 py-2 rounded hover:bg-gray-50 hover:text-[#004098] hover:border-[#004098] transition text-center font-medium">
                            <i class="fa-regular fa-envelope mr-2"></i> 发送邮件反馈
                        </a>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <!-- ================= 4. 页脚 (严格与 Index 一致) ================= -->
    <footer class="bg-[#1e293b] text-gray-400 pt-12 pb-8 mt-auto border-t-4 border-[#004098]">
        <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-10 mb-10">
                <div class="col-span-1 md:col-span-2">
                    <h4 class="text-white font-bold text-lg mb-5 border-l-4 border-[#004098] pl-3">相关部门链接</h4>
                    <div class="grid grid-cols-2 gap-y-4 gap-x-6 text-sm">
                        <a href="https://www.samr.gov.cn/" target="_blank" class="hover:text-white hover:underline flex items-center transition">
                            <i class="fa-solid fa-link mr-2 text-gray-600"></i>国家市场监督管理总局
                        </a>
                        <a href="https://www.samrdprc.org.cn/" target="_blank" class="hover:text-white hover:underline flex items-center transition">
                            <i class="fa-solid fa-link mr-2 text-gray-600"></i>国家市场监督管理总局缺陷产品召回技术中心
                        </a>
                        <a href="https://www.ccic.com/" target="_blank" class="hover:text-white hover:underline flex items-center transition">
                            <i class="fa-solid fa-link mr-2 text-gray-600"></i>中国检验认证集团
                        </a>
                        <a href="https://www.caeri.com.cn/" target="_blank" class="hover:text-white hover:underline flex items-center transition">
                            <i class="fa-solid fa-link mr-2 text-gray-600"></i>中国汽车工程研究院股份有限公司
                        </a>
                    </div>
                </div>
                <div class="col-span-1 md:col-span-1">
                    <h4 class="text-white font-bold text-lg mb-5 border-l-4 border-[#004098] pl-3">联系我们</h4>
                    <ul class="space-y-3 text-sm">
                        <li class="flex items-start"><i class="fa-solid fa-location-dot mt-1 mr-1 text-gray-500"></i> 地址：北京市朝阳区西坝河东里18号中检大厦</li>
                        <li class="flex items-center"><i class="fa-solid fa-envelope mr-3 text-gray-500"></i> 邮箱：nevsc@caeri.com.cn</li>
                        <li class="flex items-center"><i class="fa-solid fa-phone mr-3 text-gray-500"></i> 电话：010-88888888</li>
                    </ul>
                </div>
                <div class="col-span-1 md:col-span-1 flex flex-col items-center md:items-start">
                    <h4 class="text-white font-bold text-lg mb-5">关注我们</h4>
                    <div class="flex items-center gap-4">
                        <div class="bg-white p-1.5 rounded-lg shadow-lg">
                            <img src="figure/QRcode.jpg" 
                                 alt="微信公众号" class="w-20 h-20">
                        </div>
                        <div class="text-xs text-gray-400">
                            <p class="mb-1 text-white font-bold">官方微信</p>
                            <p>扫一扫了解更多</p>
                            <p>行业动态</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 pt-8 text-center text-xs text-gray-500 font-medium">
                <p>&copy; 2025 国家市场监督管理总局技术创新中心（新能源汽车数字监管技术及应用） 版权所有</p>
            </div>
        </div>
    </footer>

    <!-- 逻辑脚本 -->
    <script type="module">
        import { getItemById } from './js/api.js';
        
        // 设置 PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.0; 
        let rotation = 0;
        const canvas = document.getElementById('the-canvas');
        const ctx = canvas.getContext('2d');
        const loadingSpinner = document.getElementById('pdf-loading-spinner');

        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            if (!id) {
                document.getElementById('loading').innerHTML = '<span class="text-red-500">错误：未找到标准ID</span>';
                return;
            }

            try {
                const item = await getItemById('standards', id);

                if (item) {
                    document.title = `${item.code} 标准详情 - 技术创新中心`;
                    document.getElementById('std-code').innerText = item.code || '未编号';
                    document.getElementById('std-title').innerText = item.title || '无标题';
                    document.getElementById('std-publish-date').innerText = item.publish_date || '待定';
                    document.getElementById('std-implement-date').innerText = item.implement_date || '待定';
                    document.getElementById('std-dept').innerText = item.department || '相关归口单位';
                    document.getElementById('std-desc').innerText = item.description || '暂无详细描述...';

                    const typeMap = { 'GB': '国家标准', 'QC': '行业标准', 'DB': '地方标准', 'T': '团体标准', 'other': '其他' };
                    document.getElementById('std-type-tag').innerText = typeMap[item.type] || item.type;

                    const statusBadge = document.getElementById('std-status');
                    const statusConfig = {
                        'active': { text: '现行', class: 'badge-active' },
                        'draft': { text: '征求意见', class: 'badge-draft' },
                        'upcoming': { text: '即将实施', class: 'badge-upcoming' },
                        'expired': { text: '已废止', class: 'badge-expired' }
                    };
                    const config = statusConfig[item.status] || { text: '未知', class: 'bg-gray-100 text-gray-600' };
                    statusBadge.innerText = config.text;
                    statusBadge.className = `px-3 py-1 rounded text-sm font-bold ${config.class}`;

                    // ==========================================
                    // 权限与预览逻辑
                    // ==========================================
                    const downloadSection = document.getElementById('download-section');
                    const noDownloadSection = document.getElementById('no-download-section');
                    const pdfContainer = document.getElementById('pdf-viewer-container');
                    const placeholder = document.getElementById('pdf-placeholder');
                    const downloadBtn = document.getElementById('download-btn');

                    // 1. 预览逻辑 (只要有文件，始终初始化预览)
                    if (item.pdf_url) {
                        pdfContainer.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                        initPDFViewer(item.pdf_url); // 初始化 PDF.js
                    } else {
                        pdfContainer.classList.add('hidden');
                        placeholder.classList.remove('hidden');
                    }

                    // 2. 下载逻辑
                    if (item.pdf_url) {
                        if (item.allow_download !== false) {
                            downloadSection.classList.remove('hidden');
                            noDownloadSection.classList.add('hidden');
                            downloadBtn.href = item.pdf_url;
                        } else {
                            downloadSection.classList.add('hidden');
                            noDownloadSection.classList.remove('hidden');
                            const btn = noDownloadSection.querySelector('button');
                            const msg = noDownloadSection.querySelector('p');
                            btn.innerHTML = '<i class="fa-solid fa-lock mr-2"></i> 暂无下载权限';
                            msg.innerText = "暂不支持该文档下载";
                        }
                    } else {
                        downloadSection.classList.add('hidden');
                        noDownloadSection.classList.remove('hidden');
                        const btn = noDownloadSection.querySelector('button');
                        const msg = noDownloadSection.querySelector('p');
                        btn.innerHTML = '<i class="fa-solid fa-upload mr-2"></i> 暂无电子版';
                        msg.innerText = "该标准文件暂未上传";
                    }

                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('content-area').classList.remove('hidden');
                } else {
                    document.getElementById('loading').innerHTML = '未找到该标准信息';
                }
            } catch (error) {
                console.error(error);
                document.getElementById('loading').innerHTML = '数据加载失败，请检查网络连接';
            }
        });

        // ================= PDF.js 渲染函数 =================
        async function initPDFViewer(url) {
            try {
                // 加载文档
                const loadingTask = pdfjsLib.getDocument(url);
                pdfDoc = await loadingTask.promise;
                
                document.getElementById('pdf-page-count').textContent = pdfDoc.numPages;
                
                // 渲染第一页
                renderPage(pageNum);
                
                // 绑定按钮事件
                document.getElementById('pdf-prev').addEventListener('click', onPrevPage);
                document.getElementById('pdf-next').addEventListener('click', onNextPage);
                document.getElementById('pdf-zoom-in').addEventListener('click', onZoomIn);
                document.getElementById('pdf-zoom-out').addEventListener('click', onZoomOut);
                document.getElementById('pdf-rotate').addEventListener('click', onRotate);

            } catch (error) {
                console.error('PDF加载失败:', error);
                loadingSpinner.innerHTML = `<span class="text-red-500">PDF 加载失败</span>`;
            }
        }

        function renderPage(num) {
            pageRendering = true;
            loadingSpinner.classList.remove('hidden');

            pdfDoc.getPage(num).then(function(page) {
                // 计算自适应缩放：默认宽度撑满容器
                const wrapper = document.getElementById('canvas-wrapper');
                // 获取无缩放时的视口
                const unscaledViewport = page.getViewport({scale: 1, rotation: rotation});
                // 容器宽度减去内边距 (p-4 = 32px)
                const containerWidth = wrapper.clientWidth - 40; 
                
                // 如果是初始加载(scale=1.0)，自动计算适应宽度，否则使用当前scale
                let currentScale = scale;
                if(scale === 1.0) {
                     currentScale = containerWidth / unscaledViewport.width;
                     // 限制最大初始缩放，防止在大屏上过大
                     if(currentScale > 1.5) currentScale = 1.5;
                     scale = currentScale; // 更新全局scale
                }

                const viewport = page.getViewport({scale: scale, rotation: rotation});

                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);

                renderTask.promise.then(function() {
                    pageRendering = false;
                    loadingSpinner.classList.add('hidden');
                    
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });

            document.getElementById('pdf-page-num').textContent = num;
            updateButtons();
        }

        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        function onPrevPage() {
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        }

        function onNextPage() {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        }

        function onZoomIn() {
            scale += 0.2;
            queueRenderPage(pageNum);
        }

        function onZoomOut() {
            if (scale <= 0.4) return;
            scale -= 0.2;
            queueRenderPage(pageNum);
        }
        
        function onRotate() {
            rotation += 90;
            if (rotation === 360) rotation = 0;
            queueRenderPage(pageNum);
        }

        function updateButtons() {
            document.getElementById('pdf-prev').disabled = pageNum <= 1;
            document.getElementById('pdf-next').disabled = pageNum >= pdfDoc.numPages;
        }
    </script>
    <!-- 引入 Search 逻辑 -->
    <script type="module" src="js/search.js"></script>
</body>

</html>


